<!doctype html>
<html lang="en-IN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Club Mahabaleshwar – Member Room Booking</title>

  <!-- Minimal soft background (green → sky) -->
  <style>
    :root{
      --brand:#0f766e; --ink:#111827; --muted:#6b7280;
      --card:#ffffff; --ring:#e5e7eb; --ring-strong:#cbd5e1;
      --accent:#16a34a; --accent-2:#0284c7; --accent-3:#c2410c;
      --chip:#eef2ff; --chip-t:#3730a3; --sel:#dcfce7; --partial:#fff7ed; --closed:#fee2e2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink); font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: linear-gradient(180deg,#edf7f2 0%, #e6f4ff 60%, #fff5ee 100%);
    }
    .wrap{max-width:1120px;margin:0 auto;padding:16px 16px 64px}
    .site-header{
      display:flex;align-items:center;gap:12px;margin:8px 0 20px;
    }
    .brand-swatch{
      width:34px;height:34px;border-radius:8px;background:#74c7a7;box-shadow:0 4px 14px #0000001a;
    }
    .site-title{font-weight:700;font-size:20px}
    .badgenew{font-size:12px;background:#fef9c3;color:#854d0e;border:1px solid #fde68a;border-radius:999px;padding:2px 8px;margin-left:6px}
    .head-actions{margin-left:auto;display:flex;gap:8px}
    .btn{appearance:none;border:1px solid var(--ring-strong);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn.ghost{border-color:var(--ring);background:transparent}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 6px 24px #00000010}
    .grid{display:grid;gap:16px}
    @media (min-width:900px){ .grid-2{grid-template-columns:1.1fr .9fr} }

    /* Calendar */
    .cal-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .cal-month{font-weight:700;margin-left:auto;margin-right:auto}
    .cal-legend{display:flex;gap:12px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #e6e8ff;color:var(--chip-t);border-radius:999px;padding:4px 10px;font-size:12px}
    .cal{border:1px solid var(--ring);border-radius:14px;padding:8px}
    .cal-grid{
      display:grid;grid-template-columns:repeat(7, minmax(42px,1fr));gap:6px;
      grid-auto-rows:70px; /* Big enough to be clearly visible */
    }
    .dow{font-size:12px;color:var(--muted);text-align:center;margin:6px 0}
    .cell{
      position:relative;border:1px solid var(--ring);border-radius:10px;background:#fff;cursor:pointer;
      display:flex;align-items:flex-start;justify-content:flex-end;padding:6px;user-select:none;
    }
    .cell.other{background:#fafafa;color:#9ca3af}
    .cell.closed{background:var(--closed)}
    .cell.partial{background:var(--partial)}
    .cell .num{font-weight:600}
    .cell.selected{outline:2px solid var(--accent);box-shadow:0 0 0 3px #16a34a22}
    .cell.inrange{background:var(--sel)}
    .note{margin-top:10px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .status-row{display:flex;gap:10px;align-items:center}
    .tiny{font-size:12px}

    /* Hidden legacy controls (kept for app.js compatibility) */
    .legacy{display:none}
    footer{margin-top:22px;color:var(--muted);font-size:12px}
    .summary-box{min-height:64px}
  </style>

  <!-- Day.js + plugins (no install needed) -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.min.js"></script>
  <script>dayjs.extend(dayjs_plugin_isoWeek); dayjs.extend(dayjs_plugin_customParseFormat);</script>

  <!-- Razorpay/Firebase scripts (your app.js expects these; leave as-is) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="site-header">
      <div class="brand-swatch"></div>
      <div class="site-title">The Club Mahabaleshwar <span class="badgenew">New</span></div>
      <div class="head-actions">
        <button class="btn" id="btnLogin">Login</button>
        <button class="btn" id="btnDemo">Demo</button>
        <a class="btn ghost" href="admin/">Admin</a>
        <a class="btn ghost" href="admin/promotions.html">Promotions</a>
      </div>
    </header>

    <p id="demoBanner" class="card tiny" style="display:none;">Continuing in demo mode.</p>

    <div class="grid grid-2">
      <section class="card">
        <h2>Date selection</h2>

        <div class="cal-head">
          <button class="btn" id="prev">&larr;</button>
          <div class="cal-month" id="monthLbl">Month YYYY</div>
          <button class="btn" id="next">&rarr;</button>

          <div class="status-row" style="margin-left:auto">
            <span class="tiny">CI:</span><span class="chip" id="ciChip">—</span>
            <span class="tiny">CO:</span><span class="chip" id="coChip">—</span>
          </div>
        </div>

        <div class="cal">
          <div class="cal-grid" id="calGridHead" style="grid-auto-rows:26px">
            <div class="dow">Mon</div><div class="dow">Tue</div><div class="dow">Wed</div>
            <div class="dow">Thu</div><div class="dow">Fri</div><div class="dow">Sat</div><div class="dow">Sun</div>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>

        <div class="cal-legend" style="margin-top:10px">
          <span class="chip">Open</span>
          <span class="chip" style="background:var(--partial);border-color:#fed7aa;color:#9a3412">Partial</span>
          <span class="chip" style="background:var(--closed);border-color:#fecaca;color:#991b1b">Closed</span>
          <span class="chip" style="background:var(--sel);border-color:#bbf7d0;color:#166534">Selected range</span>
        </div>

        <p class="note">Pick check-in then check-out. “Partial” = available for some nights within the ranges defined by the club calendar.</p>
      </section>

      <section class="card">
        <h2>Availability</h2>
        <div id="availability" class="summary-box muted">Pick your dates to see rooms. “Partial” means available for some nights in the range.</div>
        <div style="margin-top:10px">
          <button class="btn primary" id="btnAvailability">Check Availability</button>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>Summary</h2>
      <div id="summary" class="summary-box muted">Select your dates from the calendar above.</div>
      <footer>Data is read from <code>/data/rooms.json</code>, <code>/data/calendar.json</code>, and <code>/data/members.csv</code>. No server required. &middot; <span id="year"></span></footer>
    </section>

    <!-- Hidden legacy controls expected by existing app.js -->
    <div class="legacy">
      <input id="checkin" type="date" />
      <input id="checkout" type="date" />
      <div id="memberInfo"></div>
    </div>
  </div>

  <!-- Your app logic (existing file) -->
  <script src="app.js"></script>

  <!-- Calendar wiring: renders big grid + syncs to hidden inputs so app.js continues to work -->
  <script>
    (function(){
      const $ = sel => document.querySelector(sel);
      const ciInput = $('#checkin');
      const coInput = $('#checkout');
      const calGrid = $('#calGrid');
      const monthLbl = $('#monthLbl');
      const ciChip = $('#ciChip');
      const coChip = $('#coChip');
      const summary = $('#summary');
      const availabilityBox = $('#availability');
      const demoBanner = $('#demoBanner');

      // show demo banner if app.js set demo (fallback)
      try {
        if (window.location.search.includes('demo') || localStorage.getItem('demo')==='1') {
          demoBanner.style.display='block';
        }
      } catch {}

      // state
      let current = dayjs().startOf('month');     // month being shown
      let selStart = null, selEnd = null;         // selected range
      let clubCalendar = {};                      // from /data/calendar.json

      // helpers
      const isoOffset = d => (d.day() + 6) % 7;   // Sunday(0) -> 6, Monday(1) -> 0
      const ymd = d => d.format('YYYY-MM-DD');
      const dmy = d => d.format('DD/MM/YYYY');

      function setHiddenInputs() {
        ciInput.value = selStart ? selStart.format('YYYY-MM-DD') : '';
        coInput.value = selEnd ? selEnd.format('YYYY-MM-DD') : '';
        ciChip.textContent = selStart ? dmy(selStart) : '—';
        coChip.textContent = selEnd ? dmy(selEnd) : '—';
        if (selStart && selEnd) {
          summary.classList.remove('muted');
          summary.textContent = `Stay: ${dmy(selStart)} → ${dmy(selEnd)}  (${selEnd.diff(selStart,'day')} nights)`;
        } else {
          summary.classList.add('muted');
          summary.textContent = 'Select your dates from the calendar above.';
        }
      }

      async function loadCalendar(){
        try{
          const res = await fetch('data/calendar.json');
          clubCalendar = await res.json();
        }catch(e){
          clubCalendar = {};
        }
      }

      function dayStatus(d){
        const rec = clubCalendar[ymd(d)];
        if (!rec) return 'open';
        if (rec.closed) return 'closed';
        if (rec.partial) return 'partial';
        return 'open';
      }

      function render(){
        monthLbl.textContent = current.format('MMMM YYYY');
        calGrid.innerHTML = '';
        // first cell = Monday of the first calendar row
        const start = current.startOf('month');
        const gridStart = start.subtract(isoOffset(start),'day');

        for (let i=0;i<42;i++){
          const d = gridStart.add(i,'day');
          const div = document.createElement('div');
          div.className = 'cell';
          if (d.month() !== current.month()) div.classList.add('other');

          const st = dayStatus(d);
          if (st==='closed') div.classList.add('closed');
          else if (st==='partial') div.classList.add('partial');

          div.dataset.date = ymd(d);
          div.innerHTML = `<span class="num">${d.date()}</span>`;

          // selection styles
          if (selStart && selEnd && d.isAfter(selStart,'day') && d.isBefore(selEnd,'day')) {
            div.classList.add('inrange');
          }
          if (selStart && ymd(d)===ymd(selStart)) div.classList.add('selected');
          if (selEnd && ymd(d)===ymd(selEnd)) div.classList.add('selected');

          div.addEventListener('click',()=>{
            if (!selStart || (selStart && selEnd)) {
              selStart = d; selEnd = null;
            } else {
              if (d.isBefore(selStart,'day')) { selEnd = selStart; selStart = d; }
              else selEnd = d;
            }
            setHiddenInputs();
            render();
          });

          calGrid.appendChild(div);
        }
      }

      // nav
      $('#prev').addEventListener('click',()=>{ current = current.subtract(1,'month'); render(); });
      $('#next').addEventListener('click',()=>{ current = current.add(1,'month'); render(); });

      // wire "Check Availability" to existing app.js button if present
      $('#btnAvailability').addEventListener('click',()=>{
        // app.js listens for this button by id; if it attached a handler, it will run.
        availabilityBox.textContent = 'Checking…';
        // nothing else needed here; app.js will read #checkin/#checkout and render.
      });

      // footer year
      document.getElementById('year').textContent = new Date().getFullYear();

      // initial
      (async function(){
        await loadCalendar();
        selStart = dayjs().add(1,'day');
        selEnd   = selStart.add(2,'day');
        setHiddenInputs();
        render();
      })();
    })();
  </script>
</body>
</html>
